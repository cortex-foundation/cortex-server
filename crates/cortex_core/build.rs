use std::env;
use std::fs;
use std::io::{Read, Result, Write};
use std::path::PathBuf;
use glob::glob;
use regex::Regex;

fn main() -> Result<()> {
    // í”„ë¡œí†  íŒŒì¼ ì°¾ê¸°
    let proto_files: Vec<PathBuf> = glob("../../proto/**/*.proto")
        .expect("Failed to read glob pattern")
        .filter_map(|entry| entry.ok())
        .collect();

    //  ì»´íŒŒì¼
    prost_build::compile_protos(&proto_files, &["../../proto/"])?;

    // íŒ¨í‚¤ì§€ ì´ë¦„ íŒŒì‹± í›„ ëª¨ë“ˆ ì½”ë“œ ìë™ ìƒì„±
    let package_regex = Regex::new(r"package\s+cortex\.(\w+);").unwrap();
    
    // ìƒì„±ë  ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ë‹´ì„ ë²„í¼
    let mut mod_code = String::new();
    mod_code.push_str("// ğŸ¤– This file is AUTO-GENERATED by build.rs\n\n");

    // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ Set (ì—¬ëŸ¬ íŒŒì¼ì´ ê°™ì€ íŒ¨í‚¤ì§€ë¥¼ ì“¸ ìˆ˜ë„ ìˆìœ¼ë‹ˆ)
    let mut generated_modules = std::collections::HashSet::new();

    for path in &proto_files {
        // íŒŒì¼ ë‚´ìš© ì½ê¸°
        let mut content = String::new();
        let mut file = fs::File::open(path)?;
        file.read_to_string(&mut content)?;

        // íŒ¨í‚¤ì§€ëª… ì°¾ê¸°
        if let Some(caps) = package_regex.captures(&content) {
            let module_name = caps.get(1).unwrap().as_str().to_string();

            // ì•„ì§ ë“±ë¡ ì•ˆ ëœ ëª¨ë“ˆì´ë©´ ì½”ë“œ ì¶”ê°€
            if !generated_modules.contains(&module_name) {
                let code = format!(
                    "pub mod {name} {{\n    include!(concat!(env!(\"OUT_DIR\"), \"/cortex.{name}.rs\"));\n}}\n\n",
                    name = module_name
                );
                mod_code.push_str(&code);
                generated_modules.insert(module_name);
            }
        }
        
        // ë³€ê²½ ê°ì§€ (ì¬ë¹Œë“œ íŠ¸ë¦¬ê±°)
        println!("cargo:rerun-if-changed={}", path.display());
    }

    // ìƒì„±ëœ ì½”ë“œë¥¼ OUT_DIR/protos_mod.rs íŒŒì¼ë¡œ ì €ì¥
    let out_dir = env::var("OUT_DIR").unwrap();
    let dest_path = PathBuf::from(out_dir).join("protos_mod.rs");
    let mut f = fs::File::create(&dest_path)?;
    f.write_all(mod_code.as_bytes())?;

    Ok(())
}